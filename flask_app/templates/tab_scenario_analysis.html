<h2>Scenario Analysis</h2>
<div>
    <div style="margin: 30px;">
        <!-- https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file -->
        <form id="scenario-form" method="post" enctype="multipart/form-data" 
            action="{{ url_for('analyse_scenario_files') }}">
            <div>
                <label for="file">Choose file to upload<br/>(CTRL + Click to select multiple files)</label>
                <br/>
                <br/>
                <input type="file" accept=".csv" id="file_uploader" name="file" multiple />
                <br/>
                <ul id="file-list"></ul>
                <br/>
                <label for="scenario_name">Scenario Name:</label><br>
                <input type="text" id="scenario-name" name="scenario_name" 
                    value="Scenario 1"
                >
                <br/>
                <br/>
                <button>Submit</button>
            </div>
        </form>          
    </div>

    <div class="tabs"> <!-- https://jqueryui.com/tabs/ -->
        <ul>
          <li><a href="#tab_scenario_events">Events</a></li>
          <li><a href="#tab_scenario_interevents">Inter Events</a></li>
        </ul>
        <div id="tab_scenario_events">
            <h2>Events Data</h2>
            <div id="scenario_table_output_01">Events Table should appear here</div>
        </div>
        <div id="tab_scenario_interevents">
            <h2>Inter Events Data</h2>
            <div id="scenario_table_output_02">Inter Events Table should appear here</div>
        </div>
    </div>

</div>

<!-- Form submission logic -->

<!-- https://stackoverflow.com/questions/5392344/sending-multipart-formdata-with-jquery-ajax -->

<script>

    createDropDown = function(label, opts){

        let select_e = $("<select/>");
        select_e.addClass("file_model_format");

        let options =  '<option value=""><strong>Model Format</strong></option>';
        $(opts).each(function(i, v){ 
            options += '<option value="'+v+'">'+v+'</option>';
        })
        select_e.html(options);
        
        list_label = $("<li/>")
        list_label.append(
            '<span class="file_label">'+label+'</span>',
            select_e
        )

        return list_label;
    };

    $(document).ready(function () {

        $("#file_uploader").change(function(event){
            console.log($("#file_uploader").val().split("\\").at(-1));


            // 1. get existing files - with annotations
            let current_files = [];         
            $("#file-list > li > span").each(function(i, e){ 
                current_files.push($(e).text());
            });

            // 2. get new set of files
            var new_files = [];
            for (var i = 0; i < $(this).get(0).files.length; ++i) {
                new_files.push($(this).get(0).files[i].name);
            }

            // 3. Set operations - https://stackoverflow.com/a/33034768
            // https://medium.com/@alvaro.saburido/set-theory-for-arrays-in-es6-eb2f20a61848
            // a. files to keep; A = new  B = old
            let files_to_add = new_files.filter(x => !current_files.includes(x));
            // b. files to remobe
            let files_to_remove = current_files.filter(x => !new_files.includes(x));

            // 4. Remove elements in the remove list based on file name
            $("#file-list > li > span").each(function(i, e){ 
                if(files_to_remove.includes($(e).text())){
                    $(e).parent().remove();
                };
            });

            // 5. Add new elements based on file name
            // https://stackoverflow.com/questions/40640069/dynamic-dropdown-options-with-jquery
            var model_opts = [
                'Bigmod - MDBA',
                'Source - NSW (res.csv)' ,
                'IQQM - NSW 10,000 years' 
            ];

            $(files_to_add).each(function(i, v){
                $("#file-list").append(createDropDown(v, model_opts))
            });
        });

        $("#scenario-form").submit(function (event) {
            
            // Need to prevent default action, 
            // allowing post response to be captured and 
            // rendered on main page, instead of either
            // a. rendering the result at "/analyse_scenario"
            // b. throwing a 405 on post submission to "/"
            // https://stackoverflow.com/a/42517904
            event.preventDefault();
            var fileFormData = new FormData();
            // // adding plain data as well: https://stackoverflow.com/a/55143036            
            // 1. populate submission metadata 
            file_config = {
                scenario: $("#scenario-name").val(),
                metadata: {}
            };
            $("#file-list > li").each(function(i, e){ 
                file_config["metadata"][$(e).children("span").text()] = $(e).children("select").find(":selected").text();
            });
            fileFormData.append('metadata', JSON.stringify(file_config));
            // appending files
            jQuery.each(jQuery('#file_uploader')[0].files, function(i, file) {
                fileFormData.append('file-'+i, file);
            });

            jQuery.ajax({
                url: '/analyse_scenario',
                data: fileFormData,
                cache: false,
                contentType: false,
                processData: false,
                method: 'POST',
                type: 'POST', // For jQuery < 1.9
                success: function(data){
                    console.log("response to /analyse_scenario");
                    console.log(data);
                    $( "#scenario_table_output_01" ).html(data["table_events"]);
                    $( "#scenario_table_output_02" ).html(data["table_interevents"]);
                },
                error: function(e) {
                    console.log(e.status);
                    console.log(e.responseText);
                }
            });

        });

    });
    
</script>